/*! For license information please see plugin.js.LICENSE.txt */
import{marked}from"marked";const DEFAULT_SLIDE_SEPARATOR="\r?\n---\r?\n",DEFAULT_VERTICAL_SEPARATOR=null,DEFAULT_NOTES_SEPARATOR="^s*notes?:",DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR="\\.element\\s*?(.+?)$",DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR="\\.slide:\\s*?(\\S.+?)$",SCRIPT_END_PLACEHOLDER="__SCRIPT_END__",CODE_LINE_NUMBER_REGEX=/\[\s*((\d*):)?\s*([\s\d,|-]*)\]/,HTML_ESCAPE_MAP={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Plugin=()=>{let t;function e(t){let e=(t.querySelector("[data-template]")||t.querySelector("script")||t).textContent;e=e.replace(new RegExp("__SCRIPT_END__","g"),"<\/script>");const r=e.match(/^\n?(\s*)/)[1].length,a=e.match(/^\n?(\t*)/)[1].length;return a>0?e=e.replace(new RegExp("\\n?\\t{"+a+"}(.*)","g"),(function(t,e){return"\n"+e})):r>1&&(e=e.replace(new RegExp("\\n? {"+r+"}(.*)","g"),(function(t,e){return"\n"+e}))),e}function r(t){const e=t.attributes,r=[];for(let a=0,n=e.length;a<n;a++){const t=e[a].name,n=e[a].value;/data\-(markdown|separator|vertical|notes)/gi.test(t)||(n?r.push(t+'="'+n+'"'):r.push(t))}return r.join(" ")}function a(e){const r=t.getConfig().markdown;return(e=e||{}).separator=e.separator||r?.separator||"\r?\n---\r?\n",e.verticalSeparator=e.verticalSeparator||r?.verticalSeparator||null,e.notesSeparator=e.notesSeparator||r?.notesSeparator||"^s*notes?:",e.attributes=e.attributes||"",e}function n(t,e){e=a(e);const r=t.split(new RegExp(e.notesSeparator,"mgi"));return 2===r.length&&(t=r[0]+'<aside class="notes">'+marked(r[1].trim())+"</aside>"),'<script type="text/template">'+(t=t.replace(/<\/script>/g,"__SCRIPT_END__"))+"<\/script>"}function o(t,e){e=a(e);const r=new RegExp(e.separator+(e.verticalSeparator?"|"+e.verticalSeparator:""),"mg"),o=new RegExp(e.separator);let s,i,l,c=0,u=!0,d=[];for(;s=r.exec(t);){i=o.test(s[0]),!i&&u&&d.push([]),l=t.substring(c,s.index),i&&u?d.push(l):d[d.length-1].push(l),c=r.lastIndex,u=i}(u?d:d[d.length-1]).push(t.substring(c));let p="";for(let a=0,E=d.length;a<E;a++)d[a]instanceof Array?(p+="<section "+e.attributes+">",d[a].forEach((function(t){p+="<section data-markdown>"+n(t,e)+"</section>"})),p+="</section>"):p+="<section "+e.attributes+" data-markdown>"+n(d[a],e)+"</section>";return p}function s(t){return new Promise((function(a){const n=[];[].slice.call(t.querySelectorAll("section[data-markdown]:not([data-markdown-parsed])")).forEach((function(t,a){t.getAttribute("data-markdown").length?n.push(function(t){return new Promise((function(e,r){const a=new XMLHttpRequest,n=t.getAttribute("data-markdown"),o=t.getAttribute("data-charset");null!==o&&""!==o&&a.overrideMimeType("text/html; charset="+o),a.onreadystatechange=function(t,a){4===a.readyState&&(a.status>=200&&a.status<300||0===a.status?e(a,n):r(a,n))}.bind(this,t,a),a.open("GET",n,!0);try{a.send()}catch(s){console.warn("Failed to get the Markdown file "+n+". Make sure that the presentation and the file are served by a HTTP server and the file can be found there. "+s),e(a,n)}}))}(t).then((function(e,a){t.outerHTML=o(e.responseText,{separator:t.getAttribute("data-separator"),verticalSeparator:t.getAttribute("data-separator-vertical"),notesSeparator:t.getAttribute("data-separator-notes"),attributes:r(t)})}),(function(e,r){t.outerHTML='<section data-state="alert">ERROR: The attempt to fetch '+r+" failed with HTTP status "+e.status+".Check your browser's JavaScript console for more details.<p>Remember that you need to serve the presentation HTML from a HTTP server.</p></section>"}))):t.outerHTML=o(e(t),{separator:t.getAttribute("data-separator"),verticalSeparator:t.getAttribute("data-separator-vertical"),notesSeparator:t.getAttribute("data-separator-notes"),attributes:r(t)})})),Promise.all(n).then(a)}))}function i(t,e,r){const a=new RegExp(r,"mg"),n=new RegExp('([^"= ]+?)="([^"]+?)"|(data-[^"= ]+?)(?=[" ])',"mg");let o,s,i=t.nodeValue;if(o=a.exec(i)){const r=o[1];for(i=i.substring(0,o.index)+i.substring(a.lastIndex),t.nodeValue=i;s=n.exec(r);)s[2]?e.setAttribute(s[1],s[2]):e.setAttribute(s[3],"");return!0}return!1}function l(t,e,r,a,n){if(null!==e&&void 0!==e.childNodes&&e.childNodes.length>0){let r=e;for(let o=0;o<e.childNodes.length;o++){const s=e.childNodes[o];if(o>0){let t=o-1;for(;t>=0;){const a=e.childNodes[t];if("function"==typeof a.setAttribute&&"BR"!==a.tagName){r=a;break}t-=1}}let i=t;"section"===s.nodeName&&(i=s,r=s),"function"!=typeof s.setAttribute&&s.nodeType!==Node.COMMENT_NODE||l(i,s,r,a,n)}}e.nodeType===Node.COMMENT_NODE&&!1===i(e,r,a)&&i(e,t,n)}function c(){const r=t.getRevealElement().querySelectorAll("[data-markdown]:not([data-markdown-parsed])");return[].slice.call(r).forEach((function(t){t.setAttribute("data-markdown-parsed",!0);const r=t.querySelector("aside.notes"),a=e(t);t.innerHTML=marked(a),l(t,t,null,t.getAttribute("data-element-attributes")||t.parentNode.getAttribute("data-element-attributes")||"\\.element\\s*?(.+?)$",t.getAttribute("data-attributes")||t.parentNode.getAttribute("data-attributes")||"\\.slide:\\s*?(\\S.+?)$"),r&&t.appendChild(r)})),Promise.resolve()}return{id:"markdown",init:function(e){t=e;let{renderer:r,animateLists:a,...n}=t.getConfig().markdown||{};return r||(r=new marked.Renderer,r.code=(t,e)=>{let r="",a="";if(CODE_LINE_NUMBER_REGEX.test(e)){let t=e.match(CODE_LINE_NUMBER_REGEX)[2];t&&(r=`data-ln-start-from="${t.trim()}"`),a=e.match(CODE_LINE_NUMBER_REGEX)[3].trim(),a=`data-line-numbers="${a}"`,e=e.replace(CODE_LINE_NUMBER_REGEX,"").trim()}return`<pre><code ${a} ${r} class="${e}">${t=t.replace(/([&<>'"])/g,(t=>HTML_ESCAPE_MAP[t]))}</code></pre>`}),!0===a&&(r.listitem=t=>`<li class="fragment">${t}</li>`),marked.setOptions({renderer:r,...n}),s(t.getRevealElement()).then(c)},processSlides:s,convertSlides:c,slidify:o,marked:marked}};export default Plugin;